# Dockerfile for running notebook tests in GCP
# Based on the main Dockerfile but optimized for testing

FROM python:3.12-slim-bookworm AS base

# Install Java runtime (required for PySpark) and procps for process management
RUN echo "deb http://deb.debian.org/debian oldstable main" >> /etc/apt/sources.list
RUN apt-get update && \
    apt-get install --no-install-recommends -y openjdk-11-jdk-headless procps make rsync curl && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Set up JAVA_HOME environment variable (adjust for architecture)
ENV JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
ENV PATH="${JAVA_HOME}/bin:${PATH}"

# Create working directory
WORKDIR /workspace

# Add UV binaries
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/

# Enable bytecode compilation
ENV UV_COMPILE_BYTECODE=1
ENV UV_LINK_MODE=copy

# Copy project files
COPY pyproject.toml uv.lock ./
COPY tests/ ./tests/
COPY notebooks/ ./notebooks/
COPY scripts/ ./scripts/

# Install dependencies
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --all-extras

# Set environment variables
ENV PATH="/workspace/.venv/bin:${PATH}"
ENV PYTHONUNBUFFERED=1

# Default command runs all tests
CMD ["uv", "run", "pytest", "tests/", "-v", "-m", "notebook"]

